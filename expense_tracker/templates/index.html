<!DOCTYPE html>
<html>
<head>
    <title>Expense Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
        .container {
            max-width: 1100px;
            margin: 40px auto;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            text-align: center;
        }
        a.back { display:block; margin-bottom: 12px; text-decoration:none; color:#555; font-size:14px; }
        h1, h2 { margin-bottom: 18px; color: #222; }
        .btn {
            display:inline-block; margin: 8px 0 18px; padding: 10px 18px;
            background:#36A2EB; color:#fff; border-radius:6px; text-decoration:none; font-weight:600;
        }
        table {
            width:100%; border-collapse: collapse; margin: 18px 0 28px; font-size:15px;
        }
        th, td { border:1px solid #e0e6ef; padding:10px; text-align:center; }
        th { background:#36A2EB; color:#fff; }
        .chart-container { display:flex; gap:20px; overflow-x:auto; padding:12px 6px; }
        .chart-box {
            flex:0 0 340px; background:#fff; border-radius:12px; padding:14px;
            box-shadow:0 6px 12px rgba(0,0,0,0.08); text-align:center;
        }
        .chart-box h3 { margin:6px 0 6px; font-size:16px; color:#333; }
        .chart-box p { margin:0 0 12px; font-size:14px; color:#666; }
        canvas { width:100% !important; height:260px !important; }
    </style>
</head>
<body>
<div class="container">
    <a class="back" href="{{ url_for('welcome') }}">â¬… Back to Home</a>

    <h1>ðŸ’° Expense Tracker</h1>
    <p><strong>Total Expenses (All Months):</strong> â‚¹{{ total }}</p>
    <a href="{{ url_for('add_expense') }}" class="btn">âž• Add New Expense</a>

    <h2>All Expenses</h2>
    <table>
        <tr><th>Amount</th><th>Category</th><th>Description</th><th>Date</th><th>Action</th></tr>
        {% for exp in expenses %}
        <tr>
            <td>â‚¹{{ exp[1] }}</td>
            <td>{{ exp[2] }}</td>
            <td>{{ exp[3] }}</td>
            <td>{{ exp[4] }}</td>
            <td><a href="{{ url_for('delete_expense', id=exp[0]) }}" style="color:#d9534f;">Delete</a></td>
        </tr>
        {% endfor %}
    </table>

    <h2>ðŸ“Š Monthly Category-wise Charts</h2>
    <div class="chart-container">
        {% for month, data in monthly_expenses.items() %}
            <div class="chart-box">
                <h3>{{ month }}</h3>
                <p><strong>Total:</strong> â‚¹{{ data.total }}</p>  <!-- âœ… Monthly Total Added -->
                <canvas id="chart-{{ loop.index }}"></canvas>
            </div>
        {% endfor %}
        {% if monthly_expenses|length == 0 %}
            <p style="color:#666">No monthly data yet. Add some expenses to see charts.</p>
        {% endif %}
    </div>
</div>

<script>
const monthly = {{ monthly_expenses | tojson | safe }};
Chart.register(ChartDataLabels);

function generateColors(n){
    const out = [];
    for(let i=0;i<n;i++){
        const hue = Math.round((360 * i) / n);
        out.push(`hsl(${hue},70%,55%)`);
    }
    return out;
}
function inr(n){ return new Intl.NumberFormat('en-IN').format(n); }

let idx = 1;
for(const [month, data] of Object.entries(monthly)){
    const labels = data.labels;
    const values = data.values;
    const colors = generateColors(values.length);

    const ctx = document.getElementById('chart-' + idx).getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: colors, borderColor:'#fff', borderWidth:1 }] },
        options: {
            responsive:true, maintainAspectRatio:false, cutout:'45%',
            plugins:{
                legend:{ position:'bottom' },
                tooltip:{
                    callbacks:{
                        label:(ctx)=>{
                            const v = ctx.raw;
                            const total = values.reduce((a,b)=>a+b,0);
                            const pct = total ? (v/total*100).toFixed(1):0;
                            return `${ctx.label}: â‚¹${inr(v)} (${pct}%)`;
                        }
                    }
                },
                datalabels:{
                    color:'#222',
                    formatter:(val, ctx)=>{
                        const total = values.reduce((a,b)=>a+b,0);
                        const pct = total ? (val/total*100):0;
                        if(pct<4) return pct.toFixed(1)+'%';
                        return `â‚¹${inr(val)}\n(${pct.toFixed(1)}%)`;
                    },
                    anchor:'end', align:'end', offset:6,
                    font:{ size:11, weight:'600' }
                }
            }
        }
    });
    idx++;
}
</script>
</body>
</html>
